#include <Keyboard.h>
#include <Adafruit_NeoPixel.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

/* ================= OLED ================= */
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

/* ================= LEDS ================= */
#define LED_PIN   26
#define LED_COUNT 9
Adafruit_NeoPixel leds(LED_COUNT, LED_PIN, NEO_GRB + NEO_KHZ800);

/* ================= MATRIZ ================= */
// Ajusta si tus pines reales son distintos
uint8_t rowPins[4] = {1, 2, 3, 4};
uint8_t colPins[3] = {27, 28, 29};

/* ================= HID F13–F24 ================= */
#define KEY_F13  0x68
#define KEY_F14  0x69
#define KEY_F15  0x6A
#define KEY_F16  0x6B
#define KEY_F17  0x6C
#define KEY_F18  0x6D
#define KEY_F19  0x6E
#define KEY_F20  0x6F
#define KEY_F21  0x70
#define KEY_F22  0x71
#define KEY_F23  0x72
#define KEY_F24  0x73

uint8_t keymap[4][3] = {
  {KEY_F13, KEY_F14, KEY_F15},
  {KEY_F16, KEY_F17, KEY_F18},
  {KEY_F19, KEY_F20, KEY_F21},
  {KEY_F22, KEY_F23, KEY_F24}
};

/* ================= DEBOUNCE ================= */
unsigned long lastPress[4][3] = {0};
const unsigned long debounceTime = 150;

/* ================= SERIAL ================= */
String serialCmd = "";

void setup() {
  Serial.begin(115200);
  Keyboard.begin();
  Wire.begin();

  // Filas
  for (int r = 0; r < 4; r++) {
    pinMode(rowPins[r], OUTPUT);
    digitalWrite(rowPins[r], HIGH);
  }

  // Columnas
  for (int c = 0; c < 3; c++) {
    pinMode(colPins[c], INPUT_PULLUP);
  }

  // LEDs
  leds.begin();
  leds.clear();
  leds.show();

  // OLED
  if (display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    display.clearDisplay();
    display.setTextColor(SSD1306_WHITE);
    display.setCursor(0, 0);
    display.setTextSize(1);
    display.println("ACC MACROPAD");
    display.println();
    display.println("Waiting data...");
    display.display();
  }
}

void loop() {
  scanMatrix();
  readSerial();
}

/* ================= MATRIZ ================= */
void scanMatrix() {
  for (int r = 0; r < 4; r++) {
    digitalWrite(rowPins[r], LOW);

    for (int c = 0; c < 3; c++) {
      if (digitalRead(colPins[c]) == LOW) {
        if (millis() - lastPress[r][c] > debounceTime) {
          sendKey(r, c);
          lastPress[r][c] = millis();
        }
      }
    }
    digitalWrite(rowPins[r], HIGH);
  }
}

void sendKey(int r, int c) {
  Keyboard.press(keymap[r][c]);
  delay(10);
  Keyboard.releaseAll();
}

/* ================= SERIAL → LEDS + OLED ================= */
void readSerial() {
  while (Serial.available()) {
    char ch = Serial.read();
    if (ch == '\n') {
      handleCommand(serialCmd);
      serialCmd = "";
    } else {
      serialCmd += ch;
    }
  }
}

void handleCommand(String c) {
  c.trim();

  if (c == "GREEN") {
    setColor(0, 255, 0);
    showFlag("GREEN");
  }
  else if (c == "YELLOW") {
    setColor(255, 150, 0);
    showFlag("YELLOW");
  }
  else if (c == "RED") {
    setColor(255, 0, 0);
    showFlag("RED");
  }
  else if (c == "BLUE") {
    setColor(0, 0, 255);
    showFlag("BLUE");
  }
  else if (c == "WHITE") {
    setColor(255, 255, 255);
    showFlag("WHITE");
  }
  else if (c == "BLACK") {
    setColor(0, 0, 0);
    showFlag("BLACK");
  }
}

void setColor(uint8_t r, uint8_t g, uint8_t b) {
  for (int i = 0; i < LED_COUNT; i++) {
    leds.setPixelColor(i, leds.Color(r, g, b));
  }
  leds.show();
}

/* ================= OLED ================= */
void showFlag(const char* flag) {
  display.clearDisplay();
  display.setCursor(0, 0);
  display.setTextSize(1);
  display.println("ACC MACROPAD");
  display.println();
  display.setTextSize(2);
  display.println("FLAG:");
  display.println(flag);
  display.display();
}
